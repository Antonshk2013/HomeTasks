Отчет о проделанной работе post mortem


    Описание Инцидента

        При переходе на сайт который находится по адресу 18.192.103.67, пользователь ожидал получить страницу
        приложения Вики, но получил сообщение об ошибке с текстом
        $wgServer must be set in LocalSettings.php. See https://www.mediawiki.org/wiki/Manual:$wgServer.

        При повторном входе ошибка была получена повторно, и на основании повторно полученной ошибки был зарегистрирован данный инцидент

    Предпринятые шаги для восстановления сервиса и устранения проблемы и полученные результаты

        Идентификация проблем/ы
            1. Подключение на сервер, анализ работы системы
                - ssh -i <путь_к_файлу> ec2-user@18.192.103.67 подключение
                 -i передаем путь к публичной части ключа
                  в данном случае при подключении используем логин стандартного пользователя сервреа AWS
            1.1. Анализ работы сервиса httpd:
                - sudo service httpd status - проверяем статус работы демона httpd, проверяем под пользователем с правами root
                Получаем информация о состоянии сервера active(running)
                Пробуем перезагрузить сервис httpd sudo service httpd restart
                Повторно получаем статус сервиса active(running)

                Пробуем обратится к сайту через браузер на ресурс 18.192.103.67
                ри повторном входе ошибка была получена повторно

            1.2. Переходим в папку с логами /var/log
            cd /var + Tab - дало ошибку "no space left on device", нет места на диске
            Идентифицируем проблему №1 "Отсутствует место на диске"
            df -h  смотрим использование места на смонтированных устройствах
                -h выводит размеры в удобочитаемом формате
            du -ah / | sort -rh | head 10 - находим первые 10 директорий в корневом разделе, которые занимают больше всего места на диске.
                -a команды du означает, что команда будет показывать размеры всех файлов и каталогов.
                -h команды du выводит размер в удобном для восприятия формате
                -r команды sort сортирует в обратном порядке, то есть от большего к меньшему.
                -h команды sort сортирует с учётом человекочитаемых чисел (например, 1K, 10M, 3G), чтобы правильно интерпретировать размеры.
            Пытаемся удалить файлы из директории /tmp для решения проблемы идентифицированной в п.1.2.
            sudo rm -rf /tmp/* - попытка освободить место под пользователем root
                -r команды rm означает удаление директорий и всех файлов и подкаталогов внутри них.
                -f команды rm означает принудительное удаление (без запроса подтверждения)
            Анализируем папку /var/log
                sudo du --max-depth=1 -h /var/log выводим размера файлов и папок в каталоге /var/log с ограничением по глубине (в данном случае глубина 1) и в удобочитаемом формате.
                --max-depth команды du ограничивает
                -h команды du выводит размер в удобном для восприятия формате
                sudo ls -alh /var/log/httpd - Определяем файл с самым большим размером, через просмотр содержимого каталога httpd
            файл access_log занимает 7 Гб, для удаления файла останавливаем работу демона systemctl под правами root.
                sudo systemctl stop httpd - останавливаем сервис httpd
                sudo rm -rf /var/log/httpd/access_log - удаляем файл лога.
                sudo systemctl start httpd - запускаем сервис httpd
            проблему №1 "Отсутствует место на диске" решили.
            Пробуем обратится к сайту через браузер на ресурс 18.192.103.67
            при повторном входе ошибка была получена повторно
            Делаем вывод проблема ксвенно влияла на работу приложения, основная проблема не устранина, ищем дальше
            1.3. Анализ файла LocalSettings.php, файла на который ссылается сообщение при попытке загрузки страницы
            Переходим в директорию местоположения файла
                cd /var/www/html/mediawiki/ - анализируем файл LocalSettings.php
                LocalSettings.php имеет размер 0 байт, еще есть файл LoclSettings.php
            Идентифицируем проблему №2 "Пустой файл LocalSettings.php, наличие похожего файла LoclSettings.php"
            Работа с файлами LocalSettings.php и LoclSettings.php
            LocalSettings.php - удаляем(файл пуст ценность нулевая)
            LoclSettings.php переименовываем в правильное название LocalSettings.php
            Перезапускаем демон
                sudo systemctl restart httpd
            Проверяем статус
                sudo systemctl status httpd
            Пробуем обратится к сайту через браузер на ресурс 18.192.103.67
            при повторном входе ошибка небыла получена повторно, произошел 301 редирект на другой IP
            Проверяем файл настроек, на наличие стороннего ИП
            sudo nano /var/www/html/mediawiki/LocalSettings.php
            ИП найден, меняем на корректный
            Перезапускаем демон
                sudo systemctl restart httpd
            Проверяем статус
                sudo systemctl status httpd
            Пробуем обратится к сайту через браузер на ресурс 18.192.103.67
            при повторном входе ошибка небыла получена повторно, сайт работает корректно
            проблему №2  "Пустой файл LocalSettings.php" решили.
            1.4. Дополнительный анализ
            Проверяем размер файла access_log. Файл растет при обращении на сайт.
                sudo ls -alh /var/log/httpd
                Проверяем содержимое директории /var/log/httpd
            Директория содержит также архивные файлы, у последнего архива часто меняется размер, несколько архивных файлов в 1 день.
            Проверяем задачи на cron
                sudo crontab -l
            Идентифицируем проблему №3 "Некорректное формирование бекапов"
            расписание настроено на выполнение 1 раз в минуту, задание создает "архив всех файлов в том числе созданных архивов"
            Решение проблемы
            Останавливаем задание cron
                sudo crontab -e
            Удаляем файлы логов
                sudo rm -rf /var/log/httpd/log_*.gz
                sudo su - дыра в безопасности, если есть возможность выполнить эту команду(Информируем админестратора сервера).
            Создаем новый скрипт для работы с Бекапами
                nano backup_log.sh

                #!/bin/bash

                LOG_DIR="/var/log/httpd"
                BACKUP_DIR="/home/ec2-user/backup_log"
                DATE=$(date +%Y%m%d)

                # будет пересоздан каталог, указанный в переменной BACKUP_DIR
                mkdir -p $BACKUP_DIR

                #создаем сжатый архив директории "httpd" с датой и временем в имени в зараннее созданной директории
                tar -czf "$BACKUP_DIR/archive_$DATE.tar.gz" $LOG_DIR

                # останавливает сервис httpd
                sudo systemctl stop httpd
                # удаляет файл access_log
                rm -f "$LOG_DIR/httpd/access_log"
                # запускает сервис httpd
                sudo systemctl start httpd

                # ищет архивы "*.tar.gz" в директории "/home/ec2-user/backup_log", которые старше 5-ти дней, и удаляет их
                #find "$BACKUP_DIR" -type f -name "*.tar.gz" -cmin +3 -exec rm -f {} +
                find "$BACKUP_DIR" -type f -name "*.tar.gz" -mtime +5 -exec rm -f {} +

            Создаем новую задачу в cron
                sudo crontab -e .../backup_log.sh
            Устанавливаем периодичность выполнения для теста 2 минуты
                #*/2 * * * */home/ec2-user/backup_log.sh
                5 3 * * */home/ec2-user/backup_log.sh - каждые сутки, в 3:05
            Проверяем расписание cron
                sudo crontab -l

            Проверяем работу скрипта
                ls -al /var/log/httpd
                ls -al /home/ec2-user/backup_log

            Проблема №3 "Некорректное формирование бекапов" решена


            Рекомендации:
        1. Имплементировать инструменты для работы с сервером, а именно:
            - мониторинг свободного пространства
            - мониторинг отклика сервера
            - мониторинг работы самого приложения и/или базы данных приложения

        Возможные решения:
        - самописные скрипты
        - сторонние приложения

        2. Отказатся от хранения логов на сервере сайта
        Возможные решения:
        - самописные скрипты для передачи логов на другой сервер
        - сторонние приложения






